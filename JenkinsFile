pipeline {
  agent any
  tools {
    nodejs 'Node18'  // Ensure this matches your Jenkins NodeJS tool name exactly
  }
  stages {
    stage('Checkout') {
      steps {
        checkout scm
      }
    }
    stage('Prepare Scripts') {
      steps {
        echo 'Prepare Scripts stage skipped chmod on Windows'
      }
    }
    stage('Install and Build React App') {
      steps {
        // npm commands run from root since package.json is at root
        bat 'npm install'
        bat 'npm run build'
      }
    }
    stage('Build & Push Docker Image') {
      steps {
        withCredentials([usernamePassword(
          credentialsId: 'dockerhub-username-id', usernameVariable: 'DOCKER_HUB_USERNAME', passwordVariable: 'DOCKER_HUB_PASSWORD')]) {
          script {
            // Pass env vars for branch and docker credentials to build script
            bat """
              set BRANCH_NAME=${env.BRANCH_NAME ?: 'dev'}
              call build.bat
            """
          }
        }
      }
    }
    stage('Deploy Application') {
      steps {
        dir("${env.WORKSPACE}") {
          bat 'call deploy.bat'
        }
      }
    }
  }
  triggers {
    githubPush()
  }
}
